// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("user") // user, moderator, admin
  isPremium     Boolean   @default(false)
  premiumUntil  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  topics        Topic[]
  comments      Comment[]
  likes         Like[]
  follows       Follow[]
  notifications Notification[]
  ratings       Rating[]
}

model Category {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  nameEn      String?  // English name for API searches
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  createdAt   DateTime @default(now())
  
  topics      Topic[]
}

model Topic {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  content     String
  slug        String   @unique
  type        String   // anime, manga, manhwa
  isPinned    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  isPopular   Boolean  @default(false)
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  authorId    String   @db.ObjectId
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categoryId  String   @db.ObjectId
  category    Category @relation(fields: [categoryId], references: [id])
  
  comments    Comment[]
  likes       Like[]
  follows     Follow[]
  
  @@index([categoryId])
  @@index([authorId])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  authorId  String   @db.ObjectId
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  topicId   String   @db.ObjectId
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  parentId  String?  @db.ObjectId // For threaded replies
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies   Comment[] @relation("CommentReplies")
  
  likes     Like[]
  
  @@index([topicId])
  @@index([authorId])
  @@index([parentId])
}

model Like {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId   String?  @db.ObjectId
  topic     Topic?   @relation(fields: [topicId], references: [id], onDelete: Cascade)
  commentId String?  @db.ObjectId
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  
  @@unique([userId, topicId, commentId])
  @@index([userId])
}

model Follow {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId   String   @db.ObjectId
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  
  @@unique([userId, topicId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  type      String   // reply, like, mention, follow, etc.
  message   String
  read      Boolean  @default(false)
  link      String?  // Link to related content
  createdAt DateTime @default(now())
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  relatedUserId String?  @db.ObjectId // User who triggered the notification
  relatedTopicId String? @db.ObjectId // Related topic
  relatedCommentId String? @db.ObjectId // Related comment
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model Rating {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  score     Int      // 1-10
  review    String?  // Optional review text
  animeId   String?  // External anime ID (from Jikan API) or Anime model ID
  animeName String?  // Anime name for reference
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  animeModelId String?  @db.ObjectId // Reference to Anime model
  animeModel   Anime?   @relation("AnimeRatings", fields: [animeModelId], references: [id], onDelete: Cascade)
  
  @@unique([userId, animeId])
  @@index([userId])
  @@index([animeId])
  @@index([animeModelId])
}

model Anime {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  malId       Int?     @unique // MyAnimeList ID
  title       String
  titleEnglish String?
  titleJapanese String?
  image       String?
  synopsis    String?
  score       Float?
  episodes    Int?
  status      String?  // Airing, Finished, etc.
  type        String?  // TV, Movie, etc.
  airedFrom   DateTime?
  airedTo     DateTime?
  genres      String?  // JSON array of genres
  officialLinks String? // JSON array of official links
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  ratings     Rating[] @relation("AnimeRatings")
  
  @@index([title])
}

